<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <title>Detalle Usuario</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel   ="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

        <style>
            body { background: #f8f9fa; }
            .profile-container {
                width: 180px;
                height: 180px;
                margin: 0 auto;
                border-radius: 50%;
                overflow: hidden;
                border: 4px solid #dee2e6;
                position: relative;
                transition: all 0.3s;
            }
            .profile-container:hover {
                border-color: #0d6efd;
                transform: scale(1.05);
            }
            .profile-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .overlay-edit {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s;
            }
            .profile-container:hover .overlay-edit {
                opacity: 1;
            }
            .direccion-item {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border-left: 4px solid #0d6efd;
                padding: 12px 16px;
                margin-bottom: 12px;
                border-radius: 8px;
                transition: all 0.2s;
            }
            .direccion-item:hover {
                transform: translateX(5px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .info-label {
                font-size: 0.85rem;
                color: #6c757d;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
        </style>
    </head>
    <body class="py-4">

        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <a th:href="@{/usuario}" 
                       class="btn btn-outline-secondary" 
                       sec:authorize="hasAnyRole('ROLE_Administrador', 'ROLE_Director')">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                    <span sec:authorize="!hasAnyRole('ROLE_Administrador', 'ROLE_Director')"></span>
                </div>

                <h3 class="text-primary mb-0">
                    <i class="bi bi-person-badge"></i> Perfil de Usuario
                </h3>

                <!-- BOTON CERRAR SESION -->
                <div>
                    <form th:action="@{/logout}" method="POST" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                        </button>
                    </form>
                </div>
            </div>

            <!-- === DESHABILITADO === -->
            <div th:if="${session.statusUsuario == 0}" 
                 class="d-flex justify-content-center align-items-center min-vh-900 bg-gradient">
                <div class="text-center p-5 bg-white shadow-lg rounded-4 border border-warning border-3" 
                     style="max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                    <div class="mb-4">
                        <i class="bi bi-shield-exclamation display-1 text-warning"></i>
                    </div>
                    <h2 class="fw-bold text-dark mb-3">Cuenta temporalmente desactivada</h2>
                    <p class="lead text-muted mb-4">
                        Tu cuenta ha sido desactivada por el administrador. 
                        No puedes realizar acciones hasta su reactivación.
                    </p>
                    <div class="bg-light p-3 rounded-3 mb-4">
                        <i class="bi bi-envelope-fill text-primary me-2"></i>
                        <strong>soporte@risosuit.com</strong>
                        <br><small class="text-muted">Escríbenos para asistencia</small>
                    </div>
                </div>
            </div>

            <!-- ALERTA ERROR GENERAL -->
            <div th:if="${errorGeneral}" class="alert alert-danger alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle"></i> [[${errorGeneral}]]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:unless="${session.statusUsuario == 0}">
                <div class="row g-4">
                    <!--  FOTO + INFO  -->
                    <div class="col-lg-4">
                        <!-- FOTO PERFIL -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body text-center p-4">
                                <div class="profile-container mb-3">
                                    <img th:src="${Usuario.Imagen != null ? 'data:image/png;base64,' + Usuario.Imagen : 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png'}" 
                                         alt="Foto perfil"
                                         onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png'">
                                    <div class="overlay-edit">
                                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalFoto">
                                            <i class="bi bi-camera"></i> Cambiar
                                        </button>
                                    </div>
                                </div>
                                <h5 class="mb-2" th:text="${Usuario.Nombre + ' ' + Usuario.ApellidoPaterno}"></h5>
                                <div class="mb-2">
                                    <span th:if="${Usuario.Status == 1}" class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Activo
                                    </span>
                                    <span th:if="${Usuario.Status == 0}" class="badge bg-danger">
                                        <i class="bi bi-x-circle"></i> Inactivo
                                    </span>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-person-circle"></i> [[${Usuario.Username}]]
                                </small>
                            </div>
                        </div>

                        <!-- INFO BASICA -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0"><i class="bi bi-info-circle text-primary"></i> Información</h6>
                                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarUsuario">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Rol</div>
                                    <span class="badge bg-primary" th:text="${Usuario.Rol?.Nombre ?: 'Sin rol'}"></span>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Email</div>
                                    <div th:text="${Usuario.Email}"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <div class="info-label">Teléfono</div>
                                        <div th:text="${Usuario.Telefono ?: 'N/A'}"></div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="info-label">Celular</div>
                                        <div th:text="${Usuario.Celular ?: 'N/A'}"></div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">CURP</div>
                                    <div th:text="${Usuario.Curp ?: 'No registrado'}"></div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="info-label">Nacimiento</div>
                                        <div th:text="${Usuario.FechaNacimiento}"></div>
                                    </div>
                                    <div class="col-6">
                                        <div class="info-label">Género</div>
                                        <div th:text="${Usuario.Sexo}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DIRECCIONES -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="mb-0">
                                        <i class="bi bi-geo-alt-fill text-primary"></i> Direcciones
                                        <span class="badge bg-secondary">[[${#lists.size(Usuario.Direcciones)}]]</span>
                                    </h5>
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregarDireccion">
                                        <i class="bi bi-plus-circle"></i> Agregar
                                    </button>
                                </div>

                                <!-- SIN DIRECCIONES -->
                                <div th:if="${#lists.isEmpty(Usuario.Direcciones)}" class="text-center py-5">
                                    <i class="bi bi-house-x display-3 text-muted mb-3"></i>
                                    <h6 class="text-muted">No hay direcciones registradas</h6>
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalAgregarDireccion">
                                        <i class="bi bi-plus"></i> Agregar primera dirección
                                    </button>
                                </div>

                                <!-- LISTA DIRECCIONES -->
                                <div th:unless="${#lists.isEmpty(Usuario.Direcciones)}">
                                    <div th:each="direccion, iter : ${Usuario.Direcciones}" class="direccion-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="fw-bold mb-1">
                                                    <i class="bi bi-geo-alt"></i>
                                                    [[${direccion.Calle}]]
                                                    <span th:if="${direccion.NumeroExterior}">
                                                        #[[${direccion.NumeroExterior}]]
                                                        <span th:if="${direccion.NumeroInterior}">Int. [[${direccion.NumeroInterior}]]</span>
                                                    </span>
                                                </div>
                                                <small class="text-muted d-block">
                                                    [[${direccion.Colonia?.Nombre ?: 'Sin colonia'}]], 
                                                    [[${direccion.Colonia?.Municipio?.Nombre ?: ''}]]
                                                </small>
                                                <small class="text-muted">
                                                    [[${direccion.Colonia?.Municipio?.Estado?.Nombre ?: ''}]], 
                                                    [[${direccion.Colonia?.Municipio?.Estado?.Pais?.Nombre ?: ''}]]
                                                </small>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-3">
                                                <button class="btn btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalEditarDireccion"
                                                        th:attr="data-usuario=${Usuario.IdUsuario},
                                                                data-direccion=${direccion.IdDireccion},
                                                                data-pais=${direccion.Colonia?.Municipio?.Estado?.Pais?.IdPais},
                                                                data-estado=${direccion.Colonia?.Municipio?.Estado?.IdEstado},
                                                                data-municipio=${direccion.Colonia?.Municipio?.IdMunicipio},
                                                                data-colonia=${direccion.Colonia?.IdColonia},
                                                                data-calle=${direccion.Calle},
                                                                data-num-int=${direccion.NumeroInterior},
                                                                data-num-ext=${direccion.NumeroExterior}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger"
                                                        th:onclick="'eliminarDireccion(' + ${direccion.IdDireccion} + ', ' + ${Usuario.IdUsuario} + ')'">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== MODALES ==================== -->

            <!-- MODAL EDITAR USUARIO -->
            <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-person-fill"></i> Editar Información de Usuario
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form th:action="@{/usuario/formEditable}" method="post">
                            <div class="modal-body">
                                <input type="hidden" name="IdUsuario" th:value="${Usuario.IdUsuario}">
                                <input type="hidden" name="Direcciones[0].IdDireccion" value="-1">
                                <input type="hidden" name="Status" th:value="${Usuario.Status}">

                                <div class="row g-3">
                                    <!-- NOMBRE -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-person"></i> Nombre <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="Nombre" 
                                               th:value="${Usuario.Nombre}" required>
                                    </div>

                                    <!-- APELLIDO PATERNO -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-person"></i> Apellido Paterno <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="ApellidoPaterno" 
                                               th:value="${Usuario.ApellidoPaterno}" required>
                                    </div>

                                    <!-- APELLIDO MATERNO -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-person"></i> Apellido Materno
                                        </label>
                                        <input type="text" class="form-control" name="ApellidoMaterno" 
                                               th:value="${Usuario.ApellidoMaterno}">
                                    </div>

                                    <!-- USERNAME -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-person-circle"></i> Username <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="Username" 
                                               th:value="${Usuario.Username}" required>
                                    </div>

                                    <!-- EMAIL -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-envelope"></i> Email <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" name="Email" 
                                               th:value="${Usuario.Email}" required>
                                    </div>

                                    <!-- ROL ADMIN/DIRECTOR -->
                                    <div class="col-md-4" sec:authorize="hasAnyRole('ROLE_Administrador', 'ROLE_Director')">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-briefcase"></i> Rol/Puesto <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" name="Rol.IdRol" required>
                                            <option value="">Selecciona un Rol</option>
                                            <option th:each="rol : ${Roles}"
                                                    th:value="${rol.IdRol}"
                                                    th:text="${rol.Nombre}"
                                                    th:selected="${rol.IdRol == Usuario.Rol?.IdRol}">
                                            </option>
                                        </select>
                                    </div>
                                    <!-- ROL HIDDEN -->
                                    <div class="col-md-4" sec:authorize="!hasAnyRole('ROLE_Administrador', 'ROLE_Director')">
                                        <input type="hidden" name="Rol.IdRol" th:value="${Usuario.Rol?.IdRol}">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-briefcase"></i> Rol/Puesto
                                        </label>
                                        <input type="text" class="form-control campo-solo-lectura" 
                                               th:value="${Usuario.Rol?.Nombre}" disabled>
                                        <small class="text-muted">No puedes modificar el rol</small>
                                    </div>

                                    <!-- CURP -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-card-text"></i> CURP
                                        </label>
                                        <input type="text" class="form-control" name="Curp" 
                                               th:value="${Usuario.Curp}" maxlength="18">
                                    </div>

                                    <!-- FECHA NACIMIENTO -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-calendar"></i> Fecha Nacimiento
                                        </label>
                                        <input type="date" class="form-control" name="FechaNacimiento" 
                                               th:value="${Usuario.FechaNacimiento}">
                                    </div>

                                    <!-- GENERO -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-gender-ambiguous"></i> Género
                                        </label>
                                        <select class="form-select" name="Sexo">
                                            <option value="N" th:selected="${Usuario.Sexo == 'N'}">No definido</option>
                                            <option value="H" th:selected="${Usuario.Sexo == 'H'}">Hombre</option>
                                            <option value="M" th:selected="${Usuario.Sexo == 'M'}">Mujer</option>
                                        </select>
                                    </div>

                                    <!-- TELEFONO -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-telephone"></i> Teléfono
                                        </label>
                                        <input type="tel" class="form-control" name="Telefono" 
                                               th:value="${Usuario.Telefono}" maxlength="10">
                                    </div>

                                    <!-- CELULAR -->
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-phone"></i> Celular
                                        </label>
                                        <input type="tel" class="form-control" name="Celular" 
                                               th:value="${Usuario.Celular}" maxlength="10">
                                    </div>

                                    <!-- PASSWORD ADMIN/DIRECTO -->
                                    <div class="col-md-4" sec:authorize="hasAnyRole('ROLE_Administrador', 'ROLE_Director')">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-lock"></i> Nueva Contraseña
                                        </label>
                                        <input type="password" class="form-control" name="Password" 
                                               placeholder="Dejar vacío para mantener actual">
                                        <small class="text-muted">Solo completa si deseas cambiar la contraseña</small>
                                    </div>
                                    <!-- PASSWORD HIDDEN  -->
                                    <div sec:authorize="!hasAnyRole('ROLE_Administrador', 'ROLE_Director')">
                                        <input type="hidden" name="Password" value="">
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- MODAL AGREGAR DIRECCION -->
            <div class="modal fade" id="modalAgregarDireccion" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-geo-alt-fill"></i> Agregar Nueva Dirección
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <form th:action="@{/usuario/formEditable}" method="post">
                            <div class="modal-body">
                                <input type="hidden" name="IdUsuario" th:value="${Usuario.IdUsuario}">
                                <input type="hidden" name="Direcciones[0].IdDireccion" value="0">

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-globe"></i> País <span class="text-danger">*</span>
                                        </label>
                                        <select id="add-pais" class="form-select" 
                                                name="Direcciones[0].Colonia.Municipio.Estado.Pais.IdPais" required>
                                            <option value="0">Selecciona un País</option>
                                            <option th:each="pais : ${Paises}" 
                                                    th:value="${pais.IdPais}" 
                                                    th:text="${pais.Nombre}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-geo-alt"></i> Estado <span class="text-danger">*</span>
                                        </label>
                                        <select id="add-estado" class="form-select"
                                                name="Direcciones[0].Colonia.Municipio.Estado.IdEstado" required>
                                            <option value="0">Selecciona un Estado</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-map"></i> Municipio <span class="text-danger">*</span>
                                        </label>
                                        <select id="add-municipio" class="form-select"
                                                name="Direcciones[0].Colonia.Municipio.IdMunicipio" required>
                                            <option value="0">Selecciona un Municipio</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-house"></i> Colonia <span class="text-danger">*</span>
                                        </label>
                                        <select id="add-colonia" class="form-select"
                                                name="Direcciones[0].Colonia.IdColonia" required>
                                            <option value="0">Selecciona una Colonia</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-signpost"></i> Calle <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="Direcciones[0].Calle" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-door-open"></i> Número Interior
                                        </label>
                                        <input type="text" class="form-control" name="Direcciones[0].NumeroInterior">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-door-closed"></i> Número Exterior <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" name="Direcciones[0].NumeroExterior" required>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-plus-circle"></i> Agregar Dirección
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- MODAL EDITAR DIRECCION -->
            <div class="modal fade" id="modalEditarDireccion" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title">
                                <i class="bi bi-geo-alt-fill"></i> Editar Dirección
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form th:action="@{/usuario/formEditable}" method="post">
                            <div class="modal-body">
                                <input type="hidden" name="IdUsuario" id="edit-idusuario">
                                <input type="hidden" name="Direcciones[0].IdDireccion" id="edit-iddireccion">

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-globe"></i> País <span class="text-danger">*</span>
                                        </label>
                                        <select id="edit-pais" class="form-select" 
                                                name="Direcciones[0].Colonia.Municipio.Estado.Pais.IdPais" required>
                                            <option value="0">Selecciona un País</option>
                                            <option th:each="pais : ${Paises}" 
                                                    th:value="${pais.IdPais}" 
                                                    th:text="${pais.Nombre}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-geo-alt"></i> Estado <span class="text-danger">*</span>
                                        </label>
                                        <select id="edit-estado" class="form-select"
                                                name="Direcciones[0].Colonia.Municipio.Estado.IdEstado" required>
                                            <option value="0">Selecciona un Estado</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-map"></i> Municipio <span class="text-danger">*</span>
                                        </label>
                                        <select id="edit-municipio" class="form-select"
                                                name="Direcciones[0].Colonia.Municipio.IdMunicipio" required>
                                            <option value="0">Selecciona un Municipio</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-house"></i> Colonia <span class="text-danger">*</span>
                                        </label>
                                        <select id="edit-colonia" class="form-select"
                                                name="Direcciones[0].Colonia.IdColonia" required>
                                            <option value="0">Selecciona una Colonia</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-signpost"></i> Calle <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit-calle" 
                                               name="Direcciones[0].Calle" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-door-open"></i> Número Interior
                                        </label>
                                        <input type="text" class="form-control" id="edit-numint"
                                               name="Direcciones[0].NumeroInterior">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-door-closed"></i> Número Exterior <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="edit-numext"
                                               name="Direcciones[0].NumeroExterior" required>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-check-circle"></i> Actualizar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- MODAL FOTO PERFIL -->
            <div class="modal fade" id="modalFoto" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-camera"></i> Actualizar Foto de Perfil
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form th:action="@{/usuario/updatePhoto}" method="post" enctype="multipart/form-data">
                                <input type="hidden" name="IdUsuario" th:value="${Usuario.IdUsuario}">
                                <div class="mb-3">
                                    <label class="form-label">Selecciona una imagen</label>
                                    <input type="file" name="imagenUsuario" class="form-control" 
                                           accept=".png,.jpeg,.jpg" required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Formatos: PNG, JPG, JPEG
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary flex-fill">
                                        <i class="bi bi-upload"></i> Subir Foto
                                    </button>
                                    <button th:if="${Usuario.Imagen != null}" 
                                            type="button" 
                                            class="btn btn-danger" 
                                            th:onclick="'eliminarFoto(' + ${Usuario.IdUsuario} + ')'">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- SCRIPTS -->
        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            const Toast = Swal.mixin({
                toast: true,
                position: "bottom-start",
                showConfirmButton: false,
                showCloseButton: true,
                timer: 6000,
                timerProgressBar: true
            });

            // ELIMINAR DIRECCION
            function eliminarDireccion(idDireccion, idUsuario) {
                Swal.fire({
                    title: '¿Eliminar dirección?',
                    text: 'No podrás revertir esta acción',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/usuario/deleteAddress/' + idDireccion + '/' + idUsuario;
                    }
                });
            }

            // ELIMINAR FOTO
            function eliminarFoto(IdUsuario) {
                Swal.fire({
                    title: '¿Eliminar foto?',
                    text: 'Se restaurará la imagen por defecto',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const token = document.querySelector('meta[name="_csrf"]').content;
                        const header = document.querySelector('meta[name="_csrf_header"]').content;

                        fetch('/usuario/deletePhoto/' + IdUsuario, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                [header]: token
                            },
                            credentials: 'include'
                        }).then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            }
                        });
                    }
                });
            }

            // CARGAR DATOS AL MODAL EDITAR DIRECCION
            document.getElementById('modalEditarDireccion').addEventListener('show.bs.modal', function (event) {
                const boton = event.relatedTarget;

                document.getElementById('edit-idusuario').value = boton.getAttribute('data-usuario');
                document.getElementById('edit-iddireccion').value = boton.getAttribute('data-direccion');
                document.getElementById('edit-calle').value = boton.getAttribute('data-calle');
                document.getElementById('edit-numint').value = boton.getAttribute('data-num-int') || '';
                document.getElementById('edit-numext').value = boton.getAttribute('data-num-ext');

                const selectPais = document.getElementById('edit-pais');
                const selectEstado = document.getElementById('edit-estado');
                const selectMunicipio = document.getElementById('edit-municipio');
                const selectColonia = document.getElementById('edit-colonia');

                selectPais.value = boton.getAttribute('data-pais');
                selectEstado.setAttribute('data-selected', boton.getAttribute('data-estado'));
                selectMunicipio.setAttribute('data-selected', boton.getAttribute('data-municipio'));
                selectColonia.setAttribute('data-selected', boton.getAttribute('data-colonia'));

                $(selectPais).trigger('change');
            });

            // ========== AGREGAR DIRECCIÓN - CASCADAS ==========
            $('#add-pais').change(function () {
                const idPais = $(this).val();
                if (idPais == '0') {
                    $('#add-estado, #add-municipio, #add-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }
                $.get('/usuario/getEstadosByPais/' + idPais, function (data) {
                    $('#add-estado').html('<option value="0">Selecciona un Estado</option>');
                    data.Objects.forEach(function (estado) {
                        $('#add-estado').append('<option value="' + estado.idEstado + '">' + estado.nombre + '</option>');
                    });
                    $('#add-municipio, #add-colonia').html('<option value="0">Selecciona primero...</option>');
                });
            });

            $('#add-estado').change(function () {
                const idEstado = $(this).val();
                if (idEstado == '0') {
                    $('#add-municipio, #add-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }
                $.get('/usuario/getMunicipiosByEstado/' + idEstado, function (data) {
                    $('#add-municipio').html('<option value="0">Selecciona un Municipio</option>');
                    data.Objects.forEach(function (municipio) {
                        $('#add-municipio').append('<option value="' + municipio.idMunicipio + '">' + municipio.nombre + '</option>');
                    });
                    $('#add-colonia').html('<option value="0">Selecciona primero...</option>');
                });
            });

            $('#add-municipio').change(function () {
                const idMunicipio = $(this).val();
                if (idMunicipio == '0') {
                    $('#add-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }
                $.get('/usuario/getColoniasByMunicipio/' + idMunicipio, function (data) {
                    $('#add-colonia').html('<option value="0">Selecciona una Colonia</option>');
                    data.Objects.forEach(function (colonia) {
                        $('#add-colonia').append('<option value="' + colonia.idColonia + '">' + colonia.nombre + '</option>');
                    });
                });
            });

            // ========== EDITAR DIRECCIÓN - CASCADAS ==========
            $('#edit-pais').change(function () {
                const idPais = $(this).val();
                const estadoSeleccionado = $('#edit-estado').attr('data-selected') || '0';

                if (idPais == '0') {
                    $('#edit-estado, #edit-municipio, #edit-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }

                $.get('/usuario/getEstadosByPais/' + idPais, function (data) {
                    $('#edit-estado').html('<option value="0">Selecciona un Estado</option>');
                    data.Objects.forEach(function (estado) {
                        const selected = estado.idEstado == estadoSeleccionado ? 'selected' : '';
                        $('#edit-estado').append('<option value="' + estado.idEstado + '" ' + selected + '>' + estado.nombre + '</option>');
                    });
                    if (estadoSeleccionado != '0') {
                        $('#edit-estado').trigger('change');
                    }
                });
            });

            $('#edit-estado').change(function () {
                const idEstado = $(this).val();
                const municipioSeleccionado = $('#edit-municipio').attr('data-selected') || '0';

                if (idEstado == '0') {
                    $('#edit-municipio, #edit-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }

                $.get('/usuario/getMunicipiosByEstado/' + idEstado, function (data) {
                    $('#edit-municipio').html('<option value="0">Selecciona un Municipio</option>');
                    data.Objects.forEach(function (municipio) {
                        const selected = municipio.idMunicipio == municipioSeleccionado ? 'selected' : '';
                        $('#edit-municipio').append('<option value="' + municipio.idMunicipio + '" ' + selected + '>' + municipio.nombre + '</option>');
                    });
                    if (municipioSeleccionado != '0') {
                        $('#edit-municipio').trigger('change');
                    }
                });
            });

            $('#edit-municipio').change(function () {
                const idMunicipio = $(this).val();
                const coloniaSeleccionada = $('#edit-colonia').attr('data-selected') || '0';

                if (idMunicipio == '0') {
                    $('#edit-colonia').html('<option value="0">Selecciona primero...</option>');
                    return;
                }

                $.get('/usuario/getColoniasByMunicipio/' + idMunicipio, function (data) {
                    $('#edit-colonia').html('<option value="0">Selecciona una Colonia</option>');
                    data.Objects.forEach(function (colonia) {
                        const selected = colonia.idColonia == coloniaSeleccionada ? 'selected' : '';
                        $('#edit-colonia').append('<option value="' + colonia.idColonia + '" ' + selected + '>' + colonia.nombre + '</option>');
                    });
                });
            });
        </script>

        <!-- ALERTAS -->
        <script th:if="${resultDeleteAddress}" th:inline="javascript">
            const resultDelete = [[${resultDeleteAddress}]];
            if (resultDelete.Correct) {
                Toast.fire({ icon: 'success', title: String(resultDelete.Object) });
            } else {
                Toast.fire({ icon: 'error', title: String(resultDelete.Object) });
            }
        </script>

        <script th:if="${resultEditUserBasic}" th:inline="javascript">
            const resultEdit = [[${resultEditUserBasic}]];
            if (resultEdit.Correct) {
                Toast.fire({ icon: 'success', title: String(resultEdit.Object) });
            } else {
                Toast.fire({ icon: 'error', title: String(resultEdit.Object) });
            }
        </script>

        <script th:if="${resultAddAddress}" th:inline="javascript">
            const resultAdd = [[${resultAddAddress}]];
            if (resultAdd.Correct) {
                Toast.fire({ icon: 'success', title: String(resultAdd.Object) });
            } else {
                Toast.fire({ icon: 'error', title: String(resultAdd.Object) });
            }
        </script>

        <script th:if="${resultEditAddress}" th:inline="javascript">
            const resultEditAddr = [[${resultEditAddress}]];
            if (resultEditAddr.Correct) {
                Toast.fire({ icon: 'success', title: String(resultEditAddr.Object) });
            } else {
                Toast.fire({ icon: 'error', title: String(resultEditAddr.Object) });
            }
        </script>

        <script th:if="${resultUpdatePhoto}" th:inline="javascript">
            const resultPhoto = [[${resultUpdatePhoto}]];
            if (resultPhoto.Correct) {
                Toast.fire({ icon: 'success', title: String(resultPhoto.Object) });
            } else {
                Toast.fire({ icon: 'error', title: String(resultPhoto.Object) });
            }
        </script>

    </body>
</html>
